/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./PluginBase","sap/ui/events/KeyCodes","sap/ui/core/Core","sap/ui/core/Element","sap/base/Log"],function(e,t,o,i,s){"use strict";var n={ROW:"row",COL:"col"};var r=e.extend("sap.m.plugins.CellSelector",{metadata:{library:"sap.m",properties:{rangeLimit:{type:"int",group:"Behavior",defaultValue:200}},events:{}}});r.prototype.isApplicable=function(){return e.prototype.isApplicable.apply(this,arguments)&&this.getConfig("isApplicable",this.getControl())};r.prototype.onActivate=function(e){e.addDelegate(this,true,this);this._oSession={cellRefs:[]};this._mTimeouts={};this._fnControlUpdate=function(e){if(this._bScrolling){this._scrollSelect(this._oSession.scrollForward,this._oSession.isVertical,e)}else{this._selectCells()}}.bind(this);this._fnOnMouseEnter=this._onmouseenter.bind(this);this._fnOnMouseOut=this._onmouseout.bind(this);this._fnOnMouseMove=this._onmousemove.bind(this);this._fnOnMouseUp=this.onmouseup.bind(this);this._registerEvents()};r.prototype.onDeactivate=function(e){e.removeDelegate(this,this);if(this._oSession){this.removeSelection();this._oSession=null;this._mTimeouts=null}this._deregisterEvents()};r.prototype.exit=function(){if(this.getControl()&&!this.getControl().isDestroyed()&&this._oSession){this.removeSelection()}this._deregisterEvents();this._oSession=null;this._mTimeouts=null;e.prototype.exit.call(this)};r.prototype.onBeforeRendering=function(){this._iRtl=o.getConfiguration().getRTL()?-1:1;if(this._oResizer){this._oResizer.remove();this._oResizer=null}};r.prototype.onAfterRendering=function(){this._deregisterEvents();this._registerEvents()};r.prototype._registerEvents=function(){if(this.getControl()){this.getControl().attachEvent(this.getConfig("scrollEvent"),this._fnControlUpdate);var e=this.getControl().getDomRef(this.getConfig("scrollArea"));if(e){e.addEventListener("mouseleave",this._fnOnMouseOut);e.addEventListener("mouseenter",this._fnOnMouseEnter)}}document.addEventListener("mousemove",this._fnOnMouseMove);document.addEventListener("mouseup",this._fnOnMouseUp)};r.prototype._deregisterEvents=function(){if(this.getControl()){this.getControl().detachEvent(this.getConfig("scrollEvent"),this._fnControlUpdate);var e=this.getControl().getDomRef(this.getConfig("scrollArea"));if(e){e.removeEventListener("mouseleave",this._fnOnMouseOut);e.removeEventListener("mouseenter",this._fnOnMouseEnter)}}document.removeEventListener("mousemove",this._fnOnMouseMove);document.removeEventListener("mouseup",this._fnOnMouseUp)};r.prototype.getSelectionRange=function(){if(!this._bSelecting){return null}var e=this._getNormalizedBounds(this._oSession.mSource,this._oSession.mTarget,true);if(isNaN(e.from.rowIndex)||isNaN(e.to.rowIndex)){return null}var t=this.getConfig("getVisibleColumns",this.getControl()).length-1;e.from.colIndex=Math.max(e.from.colIndex,0);e.to.colIndex=Math.min(e.to.colIndex,t);e.from.rowIndex=Math.max(e.from.rowIndex,0);return e};r.prototype.getSelectedRowContexts=function(){var e=this.getSelectionRange();if(!e){return[]}return this.getConfig("rowContexts",this.getControl(),e.from.rowIndex,e.to.rowIndex,this.getRangeLimit())};r.prototype.onsapspace=function(e){this._startSelection(e,false)};r.prototype.onsapupmodifiers=function(e){this._onsaparrowmodifiers(e,n.ROW,-1,0)};r.prototype.onsapdownmodifiers=function(e){this._onsaparrowmodifiers(e,n.ROW,1,0)};r.prototype.onsapleftmodifiers=function(e){this._onsaparrowmodifiers(e,n.COL,0,-1)};r.prototype.onsaprightmodifiers=function(e){this._onsaparrowmodifiers(e,n.COL,0,1)};r.prototype._onsaparrowmodifiers=function(e,t,o,i){if(e.isMarked()||!e.shiftKey){return}var s=this._getSelectableCell(e.target);if(!s){return}var r=this.getConfig("getCellInfo",this.getControl(),s);if(!this._inSelection(e.target)||!this._oSession.mSource||!this._oSession.mTarget){this._oSession.mSource=this._oSession.mTarget=r}var l=this._getNormalizedBounds(this._oSession.mSource,this._oSession.mTarget);const{from:a,to:c,focus:h}=this._getUpdatedBounds(o,i*this._iRtl,r);if(h[t+"Index"]<0||h.colIndex>=this.getConfig("getVisibleColumns",this.getControl()).length){return}this.getConfig("focusCell",this.getControl(),h,o>0);if(t==n.ROW&&(r.rowIndex==l.from.rowIndex||r.rowIndex==l.to.rowIndex)||t==n.COL&&(r.colIndex==l.from.colIndex||r.colIndex==l.to.colIndex)){this._bSelecting=true;this._selectCells(a,c);e.preventDefault();e.setMarked();e.setMarked("sapUiTableSkipItemNavigation",true)}};r.prototype.onsaphomemodifiers=function(e){};r.prototype.onsapendmodifiers=function(e){};r.prototype.onkeydown=function(e){if(!this._bSelecting||e.isMarked()){return}if(l(e,t.A,true,true)||l(e,t.A,false,false)){this.removeSelection();e.preventDefault()}};r.prototype.onkeyup=function(e){if(e.isMarked()){return}var o=this._bSelecting?this._getNormalizedBounds(this._oSession.mSource,this._oSession.mTarget):undefined;if(l(e,t.SPACE,true,false)){if(this._inSelection(e.target)){var i=this.getConfig("getCellInfo",this.getControl(),e.target);this.getConfig("selectRows",this.getControl(),o.from.rowIndex,o.to.rowIndex,i.rowIndex)&&this.removeSelection();e.setMarked()}e.preventDefault()}else if(this._bSelecting&&l(e,t.SPACE,false,true)){if(!this._inSelection(e.target)){var i=this.getConfig("getCellInfo",this.getControl(),e.target);o.from.colIndex=o.to.colIndex=i.colIndex}o.from.rowIndex=0;o.to.rowIndex=Infinity;this._selectCells(o.from,o.to);e.preventDefault()}};r.prototype.onmousedown=function(e){if(e.isMarked&&e.isMarked()){return}if(e.ctrlKey||e.metaKey){this._startSelection(e)}this._bMouseDown=true;var t=this._getSelectableCell(e.target);if(t){this._mClickedCell=this.getConfig("getCellInfo",this.getControl(),t)}};r.prototype._onmousemove=function(e){if(this._bSelecting&&!this._bMouseDown){var t=this._getNormalizedBounds(this._oSession.mSource,this._oSession.mTarget);this._updateResizers(t,e.clientX,e.clientY)}var o=this._getSelectableCell(e.target);if(!o||!this._bMouseDown){return}var i=this.getConfig("getCellInfo",this.getControl(),o);if(this._mClickedCell&&i.rowIndex==this._mClickedCell.rowIndex&&i.colIndex==this._mClickedCell.colIndex){return}window.getSelection().removeAllRanges();if(this._bBorderDown&&!this._bScrolling){var s=this._oSession.border;var n={colIndex:isNaN(s.colIndex)?0:i.colIndex-s.colIndex,rowIndex:isNaN(s.rowIndex)?0:i.rowIndex-s.rowIndex};if(n.rowIndex!=0||n.colIndex!=0){const{from:e,to:t}=this._getUpdatedBounds(n.rowIndex,n.colIndex,s);this._selectCells(e,t)}}else{this._startSelection(e,true)}};r.prototype._onmouseout=function(e){var t=this.getControl().getDomRef(this.getConfig("scrollArea"));if(!t||!this._bMouseDown){return}var o=t.getBoundingClientRect();var i,s;this._bScrolling=false;if(e.clientY>o.bottom||e.clientY<o.top){this._oSession.scrollForward=i=e.clientY>o.bottom;this._oSession.isVertical=s=true;this._bScrolling=true}if(e.clientX>o.right||e.clientX<o.left){this._oSession.scrollForward=i=e.clientX>o.right;this._oSession.isVertical=s=false;this._bScrolling=true}if(this._bScrolling){this._doScroll(i,s,e)}};r.prototype._onmouseenter=function(e){this._bScrolling=false;this._clearScroller()};r.prototype._doScroll=function(e,t,o){this._clearScroller();if(this._bScrolling){this.getConfig("scroll",this.getControl(),e,t);this._mTimeouts.scrollTimerId=setTimeout(this._doScroll.bind(this,e,t),500);if(!t){this._scrollSelect(e,t,o)}}};r.prototype._scrollSelect=function(e,t,o){if(!this._bSelecting){return}var i=this._getNormalizedBounds(this._oSession.mSource,this._oSession.mTarget);if(this._bScrolling){var s=t?n.ROW:n.COL;var r={row:0,col:0};var l=e?"to":"from";r[s]=e?1:-1;let o=i[l];if(this._bBorderDown){o=this._oSession.border}const{from:a,to:c}=this._getUpdatedBounds(r[n.ROW],r[n.COL],o);this._selectCells(a,c)}};r.prototype._clearScroller=function(){if(this._mTimeouts.scrollTimerId){window.clearTimeout(this._mTimeouts.scrollTimerId);this._mTimeouts.scrollTimerId=null}};r.prototype.onmouseup=function(e){this._bMouseDown=false;this._bBorderDown=false;this._mClickedCell=undefined;this._bScrolling=false;this._clearScroller()};r.prototype._onborderdown=function(e){this._oSession.border=Object.assign({},this._oCurrentBorder);this._bBorderDown=true;this._bMouseDown=true};r.prototype._getSelectableCell=function(e){return e&&e.closest(this.getConfig("selectableCells"))};r.prototype._inSelection=function(e){var t=this.getConfig("getCellInfo",this.getControl(),e);if(!t||!this._oSession.mSource||!this._oSession.mTarget){return false}var o=this._getNormalizedBounds(this._oSession.mSource,this._oSession.mTarget);return!(t.rowIndex<o.from.rowIndex||t.rowIndex>o.to.rowIndex||t.colIndex<o.from.colIndex||t.colIndex>o.to.colIndex)};r.prototype._startSelection=function(e,t){if(e.isMarked&&e.isMarked()){return}var o=this._getSelectableCell(e.target);if(!o){return}if(this._inSelection(o)&&!t){this.removeSelection()}else{var i=this.getConfig("getCellInfo",this.getControl(),o);var s=this._mClickedCell?this._mClickedCell:i;this._bSelecting=true;this._oSession.mSource=i;this._selectCells(s,i);this.getConfig("focusCell",this.getControl(),i)}e.preventDefault();e.setMarked&&e.setMarked()};r.prototype._getUpdatedBounds=function(e,t,o){var i=this._getNormalizedBounds(this._oSession.mSource,this._oSession.mTarget);var s=Object.assign({},o);var n=s.rowIndex==i.from.rowIndex?"from":"to";var r=s.colIndex==i.from.colIndex?"from":"to";i[n].rowIndex+=e;i[r].colIndex+=t;if(!this._bBorderDown){s.rowIndex=Math.max(0,s.rowIndex+e);s.colIndex=Math.max(0,s.colIndex+t)}else{this._oSession.border.rowIndex+=e;this._oSession.border.colIndex+=t}return{from:i.from,to:i.to,focus:s}};r.prototype._selectCells=function(e,t,o){if(!this._bSelecting){return}this._clearSelection();e=e?e:this._oSession.mSource;t=t?t:this._oSession.mTarget;var i=this._getNormalizedBounds(e,t);if(t.rowIndex==Infinity||e.rowIndex==Infinity){this.getConfig("loadContexts",this.getControl(),i.from.rowIndex,this.getRangeLimit())}this._drawSelection(i);this._oSession.mSource=e;this._oSession.mTarget=t};r.prototype._drawSelection=function(e){if(!e.from||!e.to){return}this._oSession.cellRefs=[];for(var t=e.from.rowIndex;t<=e.to.rowIndex;t++){for(var o=e.from.colIndex;o<=e.to.colIndex;o++){var i=this.getConfig("getCellRef",this.getControl(),{rowIndex:t,colIndex:o});if(i){i.classList.toggle("sapMPluginsCellSelectorTop",t==e.from.rowIndex);i.classList.toggle("sapMPluginsCellSelectorBottom",t==e.to.rowIndex);i.classList.toggle("sapMPluginsCellSelectorRight",o==e.to.colIndex);i.classList.toggle("sapMPluginsCellSelectorSelected",true);i.setAttribute("aria-selected","true");this._oSession.cellRefs.push(i);if(o==e.from.colIndex){const s=this.getConfig("getCellRef",this.getControl(),{rowIndex:t,colIndex:o-1});let n="sapMPluginsCellSelectorLeft";if(s){i=s;n="sapMPluginsCellSelectorRight";this._oSession.cellRefs.push(i)}i.classList.toggle(n,o==e.from.colIndex)}}}}};r.prototype._updateResizers=function(e,t,o){var i=this._getResizer();if(this._iRtl==-1){const t=e.from.colIndex;e.from.colIndex=e.to.colIndex;e.to.colIndex=t}var s=this.getConfig("getCellRef",this.getControl(),e.from,false),r=this.getConfig("getCellRef",this.getControl(),e.to,false);var l={0:false,1:false};if(!s){l[0]=true;s=this.getConfig("getCellRef",this.getControl(),e.from,true)}if(!r){l[1]=true;r=this.getConfig("getCellRef",this.getControl(),e.to,true)}var a=s.getBoundingClientRect(),c=r.getBoundingClientRect(),h=this.getControl().getDomRef().getBoundingClientRect();var g=this.getControl().getDomRef().offsetLeft;var f={x:{0:a.left-g,1:c.left+c.width-g},y:{0:a.top-h.top,1:c.top+c.height-h.top}};var u={x:{0:t-a.left,1:t-c.right},y:{0:o-a.top,1:o-c.bottom}};var d=0;d|=Math.abs(u.x[0])<Math.abs(u.x[1])?0:1;d|=Math.abs(u.y[0])<Math.abs(u.y[1])?0:2;var m=Math.abs(u.x[d&1]),_=Math.abs(u.y[d>>1&1]);if(m>10&&_>10||m>10&&l[d>>1&1]){return}i.style.left=m<=10?f.x[d&1]+"px":f.x[0]+"px";i.style.top=_<=10?f.y[d>>1&1]+"px":f.y[0]+"px";i.style.width=m<=10?"":c.right-a.left+"px";i.style.height=m<=10?c.bottom-a.top+"px":"";const p=m<=10,C=_<=10;i.classList.toggle("sapMPluginsVerticalBorder",p);i.classList.toggle("sapMPluginsHorizontalBorder",C);i.classList.toggle("sapMPluginsEdge",p&&C);i.classList.toggle("sapMPluginsNESW",p&&C&&(d==2||d==1));i.classList.toggle("sapMPluginsNWSE",p&&C&&(d==3||d==0));this._oCurrentBorder={};if(p){this._oCurrentBorder.colIndex=d&1?e.to.colIndex:e.from.colIndex;this._oCurrentBorder.type=n.COL}if(C){this._oCurrentBorder.rowIndex=d>>1&1?e.to.rowIndex:e.from.rowIndex;this._oCurrentBorder.type=n.ROW}};r.prototype._getResizer=function(){if(!this._oResizer){this._oResizer=document.createElement("div");this._oResizer.setAttribute("id","cs-rsz");this._oResizer.classList.add("sapMPluginsCellSelectorRsz");this._oResizer.addEventListener("mousedown",this._onborderdown.bind(this));if(this.getControl().getDomRef()){this.getControl().getDomRef().appendChild(this._oResizer)}}return this._oResizer};r.prototype._clearSelection=function(){this._oSession.cellRefs.forEach(function(e){e.classList.remove("sapMPluginsCellSelectorSelected","sapMPluginsCellSelectorTop","sapMPluginsCellSelectorBottom","sapMPluginsCellSelectorLeft","sapMPluginsCellSelectorRight");e.removeAttribute("aria-selected")});var e=this._getResizer();e.style.left="-10000px";e.style.top="-10000px"};r.prototype.removeSelection=function(){this._clearSelection();this._bSelecting=false;this._oSession={cellRefs:[]}};r.prototype._getNormalizedBounds=function(e,t,o){const i=this.getConfig("getVisibleColumns",this.getControl()).length;const s=this.getRangeLimit()==0?this.getConfig("getRowCount",this.getControl()):this.getRangeLimit();let n=Math.max(e.rowIndex,t.rowIndex),r=Math.max(e.colIndex,t.colIndex);if(!o){n=Math.min(s-1,n);r=Math.min(i,r)}return{from:{rowIndex:Math.max(0,Math.min(e.rowIndex,t.rowIndex)),colIndex:Math.max(0,Math.min(e.colIndex,t.colIndex))},to:{rowIndex:n,colIndex:r}}};function l(e,t,o,i){return e.keyCode==t&&e.shiftKey==o&&(e.ctrlKey==i||e.metaKey==i)}e.setConfigs({"sap.ui.table.Table":{selectableCells:".sapUiTableDataCell",scrollArea:"sapUiTableCtrlScr",scrollEvent:"_rowsUpdated",isApplicable:function(e){return!e.hasListeners("cellClick")&&e.getSelectionBehavior()=="RowSelector"&&!e.getDragDropConfig().some(e=>e.getSourceAggregation()=="rows")},getVisibleColumns:function(e){return e.getColumns().filter(function(e){return e.getDomRef()})},getRowCount:function(e){return e._getTotalRowCount()},getCellRef:function(e,t,o){var i=e.getRows();var s=i.find(function(e){return e.getIndex()==t.rowIndex});if(s){var n=this.getVisibleColumns(e)[t.colIndex];var r=n&&s.getCells()[t.colIndex];if(r){return r.$().closest(this.selectableCells)[0]}}else if(o){if(i[0].getIndex()>t.rowIndex){s=i[0];var n=this.getVisibleColumns(e)[t.colIndex];var r=n&&s.getCells()[t.colIndex];if(r){return r.$().closest(this.selectableCells)[0]}}else if(i[i.length-1].getIndex()<t.rowIndex){s=i[i.length-1];var n=this.getVisibleColumns(e)[t.colIndex];var r=n&&s.getCells()[t.colIndex];if(r){return r.$().closest(this.selectableCells)[0]}}}},getCellInfo:function(e,t){return{rowIndex:i.closestTo(t,true).getIndex(),colIndex:this.getVisibleColumns(e).indexOf(o.byId(t.getAttribute("data-sap-ui-colid")))}},loadContexts:function(e,t,o){var i=e.getBinding("rows");if(!i||i.isA("sap.ui.model.ClientListBinding")){return}i.getContexts(Math.max(0,t),Math.max(1,o),0,true)},rowContexts:function(e,t,o,i){if(o==Infinity){var s=e.getBinding("rows").getAllCurrentContexts().length-1;o=Math.min(o,t+i-1,s)}var n=[];for(var r=t;r<=o;r++){n.push(e.getContextByIndex(r))}return n},selectRows:function(t,o,i,s){var n=e.getPlugin(t,"sap.ui.table.plugins.SelectionPlugin")||t;var r=t.getSelectionMode();if(r=="None"){return false}else if(r=="Single"){o=i=s}if(n.addSelectionInterval){n.addSelectionInterval(o,i);return true}var l=t.getRows().filter(function(e){return e.getIndex()>=o&&e.getIndex()<=i});l.forEach(function(e){n.setSelected(e,true)});return true},focusCell:function(e,t,o){var i=this.getCellRef(e,t);if(!i){this.scroll(e,o,true);return}i.focus()},scroll:function(e,t,o){if(o){var i=e.getFirstVisibleRow();var s=t?i+1:i-1;if(s>=0&&s!=i){e.setFirstVisibleRow(s);return Promise.resolve()}}else{var n=e._getScrollExtension().getHorizontalScrollbar();var r=Math.pow(-1,+!t)*10;n.scrollLeft=Math.max(0,n.scrollLeft+r);return Promise.resolve()}return false}}},r);return r});
//# sourceMappingURL=CellSelector.js.map