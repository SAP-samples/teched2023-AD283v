/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./PluginBase","sap/base/Log","sap/ui/core/Core","sap/base/strings/formatMessage","sap/m/OverflowToolbarButton","../library"],function(t,e,o,r,n,i){"use strict";const a=i.plugins.CopyPreference;var s=t.extend("sap.m.plugins.CopyProvider",{metadata:{library:"sap.m",properties:{extractData:{type:"function",invalidate:false},copySparse:{type:"boolean",defaultValue:false,invalidate:false},excludeContext:{type:"function",invalidate:false},visible:{type:"boolean",defaultValue:true,invalidate:false},copyPreference:{type:"sap.m.plugins.CopyPreference",defaultValue:a.Cells,invalidate:false}},events:{copy:{allowPreventDefault:true,parameters:{data:{type:"any[][]"}}}}}});function l(t){return t!=null}function u(t){if(l(t)){var e=String(t);return/\n|\r|\t/.test(e)?'"'+e.replaceAll('"','""')+'"':e}else{return""}}function p(t){var e=t.map(function(t){return t.map(u).join("\t")}).join("\n");return navigator.clipboard.writeText(e)}s.prototype._shouldManageExtractData=function(){var t=this.getControl();var e=this.getParent();return t!==e&&e.indexOfDependent(this)==-1};s.prototype.isApplicable=function(){if(!navigator.clipboard){throw new Error(this+" requires a secure context in order to access the clipboard API.")}if(this._shouldManageExtractData()){if(this.getExtractData()){throw new Error("extractData property must not be defined for "+this)}if(!this.getParent().getColumnClipboardSettings){throw new Error("getColumnClipboardSettings method must be defined for "+this.getParent())}}else if(!this.getExtractData()){throw new Error("extractData property must be defined for "+this)}return true};s.prototype.onActivate=function(t){this._oDelegate={onkeydown:this.onkeydown};t.addEventDelegate(this._oDelegate,this);this._oCopyButton&&this._oCopyButton.setEnabled(true);this._shouldManageExtractData()&&this.setExtractData(this._extractData.bind(this))};s.prototype.onDeactivate=function(t){t.removeEventDelegate(this._oDelegate,this);this._oDelegate=null;this._oCopyButton&&this._oCopyButton.setEnabled(false);this._shouldManageExtractData()&&this.setExtractData()};s.prototype.setVisible=function(t){this.setProperty("visible",t,true);this._oCopyButton&&this._oCopyButton.setVisible(this.getVisible());return this};s.prototype.setParent=function(){t.prototype.setParent.apply(this,arguments);if(!this.getParent()&&this._oCopyButton){this._oCopyButton.destroy(true);this._oCopyButton=null}};s.prototype.getCopyButton=function(t){if(!this._oCopyButton){this._oCopyButton=new n(Object.assign({icon:"sap-icon://copy",visible:this.getVisible(),tooltip:o.getLibraryResourceBundle("sap.m").getText("COPYPROVIDER_COPY"),press:this.copySelectionData.bind(this,true)},t))}return this._oCopyButton};s.prototype.exit=function(){if(this._oCopyButton){this._oCopyButton.destroy(true);this._oCopyButton=null}if(this._mColumnClipboardSettings){this._mColumnClipboardSettings=null}};s.prototype.getSelectionData=function(){var e=this.getControl();var r=this.getExtractData();if(!e||!r||!navigator.clipboard){return[]}var n=this.getConfig("selectableColumns",e);if(!n.length){return[]}if(e.getParent().isA("sap.ui.mdc.Table")){n=n.map(function(t){return o.byId(t.getId().replace(/\-innerColumn$/,""))})}var i=[];var s=[];var u=[];var p=this.getCopySparse();var c=this.getExcludeContext();var g=t.getPlugin(this.getParent(),"sap.m.plugins.CellSelector");var f=g&&g.getSelectionRange();var h=f?g.getSelectedRowContexts():[];var d=Boolean(h.length);var y=d||p;if(this.getCopyPreference()==a.Full||!d){s=this.getConfig("selectedContexts",e,y);Object.assign(u,s)}if(d){Object.assign(u,Array(f.from.rowIndex).concat(h))}for(var C=0;C<u.length;C++){var v=u[C];if(!v){if(p&&i.length){i.push(Array(i[0].length))}}else if(c&&c(v)){continue}else{var m=[];var b=v==s[C];n.forEach(function(t,e){if(b||e>=f?.from.colIndex&&e<=f?.to.colIndex){var o=r(v,t);if(l(o)){m.push[Array.isArray(o)?"apply":"call"](m,o)}}else if(s.length){m.push(undefined)}});if(p||m.some(l)){i.push(m)}}}return i};s.prototype.copySelectionData=function(t){var e=this.getSelectionData();if(!e.length||t&&!this.fireCopy({data:e},true)){return Promise.resolve()}return p(e)};s.prototype.onkeydown=function(t){if(t.isMarked()||t.code!="KeyC"||!(t.ctrlKey||t.metaKey)||!t.target.matches(this.getConfig("allowForCopySelector"))){return}t.setMarked();t.preventDefault();this.copySelectionData(true)};s.prototype._extractData=function(t,o){if(!this._mColumnClipboardSettings){this._mColumnClipboardSettings=new WeakMap}var n=this._mColumnClipboardSettings.get(o);if(n===undefined){n=this.getParent().getColumnClipboardSettings(o);this._mColumnClipboardSettings.set(o,n)}if(!n){return}var i=n.properties.map(function(o,r){var i=t.getProperty(o);var a=n.types[r];if(a){try{i=a.formatValue(i,"string")}catch(t){e.error(this+': Formatting error during copy "'+t.message+'"')}}return l(i)?i:""});var a=n.unitFormatter;if(a){i[0]=a(i[0],i[1])}var s=r(n.template,i).trim();return s};t.setConfigs({"sap.m.Table":{allowForCopySelector:".sapMLIBFocusable,.sapMLIBSelectM,.sapMLIBSelectS",selectedContexts:function(t,e){var o=[];var r=t.getBindingInfo("items");t.getItems(true).forEach(function(t,n){if(t.isSelectable()&&t.getVisible()){if(t.getSelected()){var i=r?t.getBindingContext(r.model):t;var a=e?n:o.length;o[a]=i}}});return o},selectableColumns:function(t){return t.getRenderedColumns()}},"sap.ui.table.Table":{allowForCopySelector:".sapUiTableCell",selectedContexts:function(e,o){var r=t.getPlugin(e,"sap.ui.table.plugins.SelectionPlugin")||e;if(r.getSelectedContexts){return r.getSelectedContexts()}var n=[];r.getSelectedIndices().forEach(function(t){var r=e.getContextByIndex(t);if(r){var i=o?t:n.length;n[i]=r}});return n},selectableColumns:function(t){return t.getColumns().filter(function(t){return t.getDomRef()})}}},s);return s});
//# sourceMappingURL=CopyProvider.js.map