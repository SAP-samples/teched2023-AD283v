/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/m/Table","sap/m/ToolbarSpacer","sap/m/upload/UploadSetwithTableRenderer","sap/ui/unified/FileUploader","sap/m/upload/UploadSetToolbarPlaceholder","sap/m/upload/UploaderHttpRequestMethod","sap/m/OverflowToolbar","sap/m/upload/UploadSetwithTableItem","sap/base/util/deepEqual","sap/base/Log","sap/m/library","sap/m/IllustratedMessageType","sap/m/IllustratedMessage","sap/m/IllustratedMessageSize","sap/m/upload/UploaderTableItem","sap/ui/core/dnd/DragDropInfo","sap/ui/core/dnd/DropInfo","sap/ui/core/dnd/DragInfo","sap/m/upload/FilePreviewDialog","sap/ui/base/Event","sap/m/Dialog","sap/m/Label","sap/m/Input","sap/m/MessageBox","sap/m/Button","sap/ui/base/Event","sap/ui/core/Core"],function(e,t,i,o,a,l,r,s,n,p,d,u,h,g,m,f,_,c,T,y,U,E,D,I,F,b,S){"use strict";var M=e.extend("sap.m.upload.UploadSetwithTable",{metadata:{library:"sap.m",properties:{fileTypes:{type:"string[]",defaultValue:null},maxFileNameLength:{type:"int",defaultValue:null},maxFileSize:{type:"float",defaultValue:null},mediaTypes:{type:"string[]",defaultValue:null},noDataText:{type:"string",defaultValue:"No documents available"},noDataDescription:{type:"string",defaultValue:"Drag and drop files here to upload"},uploadUrl:{type:"string",defaultValue:null},httpRequestMethod:{type:"sap.m.upload.UploaderHttpRequestMethod",defaultValue:l.Post},multiple:{type:"boolean",group:"Behavior",defaultValue:false},uploadButtonInvisible:{type:"boolean",group:"Appearance",defaultValue:false},uploadEnabled:{type:"boolean",defaultValue:true},itemValidationHandler:{type:"function",defaultValue:null},directory:{type:"boolean",group:"Behavior",defaultValue:false},noDataIllustrationType:{type:"sap.m.IllustratedMessageType",group:"Appearance",defaultValue:u.UploadCollection}},aggregations:{headerToolbar:{type:"sap.m.OverflowToolbar",multiple:false},uploader:{type:"sap.m.upload.UploaderTableItem",multiple:false},headerFields:{type:"sap.ui.core.Item",multiple:true,singularName:"headerField"},additionalFooterButtons:{type:"sap.m.Button",multiple:true}},associations:{previewDialog:{type:"sap.m.upload.FilePreviewDialog",multiple:false}},defaultAggregation:"items",events:{itemRenamed:{parameters:{item:{type:"sap.m.upload.UploadSetwithTableItem"}}},beforeUploadStarts:{parameters:{item:{type:"sap.m.upload.UploadSetwithTableItem"}},allowPreventDefault:true},uploadCompleted:{parameters:{item:{type:"sap.m.upload.UploadSetwithTableItem"},response:{type:"string"},readyState:{type:"string"},status:{type:"string"},responseXML:{type:"string"},responseText:{type:"string"},headers:{type:"object"}}},fileTypeMismatch:{parameters:{item:{type:"sap.m.upload.UploadSetwithTableItem"}}},fileNameLengthExceeded:{parameters:{item:{type:"sap.m.upload.UploadSetwithTableItem"}}},fileSizeExceeded:{parameters:{item:{type:"sap.m.upload.UploadSetwithTableItem"}}},mediaTypeMismatch:{parameters:{item:{type:"sap.m.upload.UploadSetwithTableItem"}}},beforeInitiatingItemUpload:{parameters:{item:{type:"sap.m.upload.UploadSetwithTableItem"}}},itemDragStart:{},itemDrop:{}}},renderer:i});var v=d.UploadState;M.prototype.init=function(){e.prototype.init.call(this);this._setDragDropConfig();this._filesTobeUploaded=[];this._filePreviewDialogControl=null;this._oRb=S.getLibraryResourceBundle("sap.m")};M.prototype.onBeforeRendering=function(){e.prototype.onBeforeRendering.call(this);this._setIllustratedMessage()};M.prototype.onAfterRendering=function(){e.prototype.onAfterRendering.call(this)};M.prototype.exit=function(){e.prototype.exit.call(this);if(this._oToolbar){this._oToolbar.destroy();this._oToolbar=null}if(this._oFileUploader){this._oFileUploader.destroy();this._oFileUploader=null}if(this._illustratedMessage){this._illustratedMessage.destroy();this._illustratedMessage=null}};M.prototype.getHeaderToolbar=function(){if(!this._oToolbar){this._oToolbar=this.getAggregation("headerToolbar");if(!this._oToolbar){this._oToolbar=new r(this.getId()+"-toolbar",{content:[new t,this.getDefaultFileUploader()]});this._iFileUploaderPH=2;this.addDependent(this._oToolbar)}else{this._iFileUploaderPH=this._getFileUploaderPlaceHolderPosition(this._oToolbar);if(this._oToolbar&&this._iFileUploaderPH>-1){this._setFileUploaderInToolbar(this.getDefaultFileUploader())}else if(this._oToolbar){this._oToolbar.addContent(this.getDefaultFileUploader())}}}return this._oToolbar};M.prototype.setFileTypes=function(e){var t=e||null;if(typeof t==="string"){t=t.split(",")}t=(t||[]).map(function(e){return e?e.toLowerCase():""});if(!n(this.getFileTypes(),t)){this.setProperty("fileTypes",t,true);this.getDefaultFileUploader().setFileType(t)}return this};M.prototype.setMaxFileNameLength=function(e){if(this.getMaxFileNameLength()!==e){this.setProperty("maxFileNameLength",e,true);this.getDefaultFileUploader().setMaximumFilenameLength(e)}return this};M.prototype.setMaxFileSize=function(e){if(this.getMaxFileSize()!==e){this.setProperty("maxFileSize",e,true);this.getDefaultFileUploader().setMaximumFileSize(e)}return this};M.prototype.setMediaTypes=function(e){var t=e||null;if(typeof t==="string"){t=t.split(",")}t=(t||[]).map(function(e){return e?e.toLowerCase():""});if(!n(this.getMediaTypes(),t)){this.setProperty("mediaTypes",t,true);this.getDefaultFileUploader().setMimeType(t)}return this};M.prototype.setUploadButtonInvisible=function(e){if(e!==this.getUploadButtonInvisible()){this.setProperty("uploadButtonInvisible",e,true)}return this};M.prototype.setMultiple=function(e){if(this.getMultiple()!==e){this.setProperty("multiple",e);this.getDefaultFileUploader().setMultiple(e)}return this};M.prototype.setUploadEnabled=function(e){if(e!==this.getUploadEnabled()){this.getDefaultFileUploader().setEnabled(e);this.setProperty("uploadEnabled",e,false)}return this};M.prototype.setMultiple=function(e){if(this.getMultiple()!==e){this.setProperty("multiple",e);this.getDefaultFileUploader().setMultiple(e)}return this};M.prototype.setDirectory=function(e){if(this.getDirectory()!==e){this.setProperty("directory",e);this.getDefaultFileUploader().setDirectory(e);if(e){this.setProperty("multiple",false)}}return this};M.prototype.getDefaultFileUploader=function(){var e="Upload";if(!this._oFileUploader){this._oFileUploader=new o(this.getId()+"-uploader",{buttonOnly:true,buttonText:e,tooltip:e,iconOnly:false,enabled:this.getUploadEnabled(),icon:"",iconFirst:false,style:"Transparent",name:"UploadSetwithTableFileUploader",sameFilenameAllowed:true,fileType:this.getFileTypes(),mimeType:this.getMediaTypes(),maximumFilenameLength:this.getMaxFileNameLength(),maximumFileSize:this.getMaxFileSize(),multiple:this.getDirectory()?false:this.getMultiple(),useMultipart:false,sendXHR:true,change:[this._onFileUploaderChange,this],typeMissmatch:[this._fireFileTypeMismatch,this],fileSizeExceed:[this._fireFileSizeExceed,this],filenameLengthExceed:[this._fireFilenameLengthExceed,this],visible:true,directory:this.getDirectory()})}return this._oFileUploader};M.getIconForFileType=function(e,t){return s._getIconByMimeType(e,t)};M.prototype.downloadItems=function(e,t){if(e&&e.length){e.forEach(function(e){var i=e&&e instanceof s?true:false;var o=e&&e.getParent?e.getParent():null;if(i&&o===this){this._getActiveUploader().download(e,[],t)}else{p.warning("Download cannot proceed without a parent association.")}}.bind(this))}};M.prototype.registerUploaderEvents=function(e){e.attachUploadStarted(this._onUploadStarted.bind(this));e.attachUploadCompleted(this._onUploadCompleted.bind(this))};M.prototype.fileSelectionHandler=function(){var e=this.getDefaultFileUploader();if(e&&e.oFileUpload&&e.oFileUpload.click){e.oFileUpload.click()}};M.getFileSizeWithUnits=function(e){var t=1024;var i=t*1024;var o=i*1024;if(typeof e==="number"){if(e<i){return(e/t).toFixed(2)+" KB"}else if(e<o){return(e/i).toFixed(2)+" MB"}else{return(e/o).toFixed(2)+" GB"}}return e};M.prototype.uploadItemViaUrl=function(e,t,i){var o=new File([new Blob([])],e);var a=new s({uploadState:v.Ready});a._setFileObject(o);a.setFileName(o.name);a.setUrl(t);i.then(()=>this._initateItemUpload(a).bind(this)).catch(()=>a.destroy());return a};M.prototype.uploadItemWithoutFile=function(e){var t=new File([new Blob([])],"-");var i=new s({uploadState:v.Ready});i._setFileObject(t);i.setFileName(t.name);e.then(()=>this._initateItemUpload(i)).catch(()=>i.destroy());return i};M.prototype.renameItem=function(e){if(e&&e instanceof s){const t=this._getFileRenameDialog(e);t.open()}};M.prototype._setFileUploaderInToolbar=function(e){this._oToolbar.getContent()[this._iFileUploaderPH].setVisible(false);this._oToolbar.insertContent(e,this._iFileUploaderPH)};M.prototype._getFileUploaderPlaceHolderPosition=function(e){for(var t=0;t<e.getContent().length;t++){if(e.getContent()[t]instanceof a){return t}}return-1};M.prototype._onFileUploaderChange=function(e){var t=e.getParameter("files");if(t&&t.length){var i=this.getSelectedItems();var o=i&&i.length==1?i[0]:null;var a=o?o&&o.getFileName&&o.getFileName()==="-":false;if(a){this._oItemToUpdate=t[0]}this._processSelectedFileObjects(t)}};M.prototype._processSelectedFileObjects=function(e){var t=[];for(var i=0;i<e.length;i++){t.push(e[i])}t.forEach(e=>{var i=new s({uploadState:v.Ready});i._setFileObject(e);i.setFileName(e.name);if(this.getItemValidationHandler()&&typeof this.getItemValidationHandler()==="function"){const e={oItem:i,iTotalItemsForUpload:t.length};var o=this.getItemValidationHandler()(e);if(o&&o instanceof Promise){o.then(e=>{if(e instanceof s){this._initateItemUpload(e)}}).catch(e=>{if(e&&this._oItemToUpdate&&e instanceof s&&e.getId()===this._oItemToUpdate.getId()){this._oItemToUpdate=null}})}else{i.destroy();p.error("Invalid usage, missing Promise: ItemValidationHandler callback expects Promise to be returned.")}}else{this._initateItemUpload(i)}})};M.prototype._initateItemUpload=function(e){this.fireBeforeInitiatingItemUpload({item:e});if(this._oItemToUpdate){this._oItemToUpdate=e}this._uploadItemIfGoodToGo(e)};M.prototype._fireFileTypeMismatch=function(e){var t=this.getMediaTypes();var i=this.getFileTypes();var o=e.getParameter("fileType");var a=e.getParameter("mimeType");var l=!!t&&t.length>0&&!!a&&t.indexOf(a)===-1;var r=!!i&&i.length>0&&!!o&&i.indexOf(o)===-1;var s={fileType:o,mimeType:a};if(l){this.fireMediaTypeMismatch({item:s})}else if(r){this.fireFileTypeMismatch({item:s})}};M.prototype._fireFilenameLengthExceed=function(e){this.fireFileNameLengthExceeded({item:e})};M.prototype._fireFileSizeExceed=function(e){this.fireFileSizeExceeded({item:e})};M.prototype._onUploadStarted=function(e){var t=e.getParameter("item");t.setUploadState(v.Uploading)};M.prototype._onUploadCompleted=function(e){var t=e.getParameter("item"),i=e.getParameter("responseXHR"),o=null;if(i.responseXML){o=i.responseXML.documentElement.textContent}var a={item:t,response:i.response,responseXML:o,responseText:i.responseText,readyState:i.readyState,status:i.status,headers:i.headers};if(this._oItemToUpdate){this._oItemToUpdate.setFileName(t.getFileName());this._oItemToUpdate._setFileObject(t.getFileObject());this._oItemToUpdate=null}t.setUploadState(v.Complete);this.fireUploadCompleted(a)};M.prototype._uploadItemIfGoodToGo=function(e){if(e.getUploadState()===v.Ready&&!e._isRestricted()){if(this.fireBeforeUploadStarts({item:e})){const t=this.getHeaderFields()?.length?this.getHeaderFields():[];const i=e.getHeaderFields()?.length?e.getHeaderFields():[];const o=[...t,...i];this._getActiveUploader().uploadItem(e,o)}}};M.prototype._getActiveUploader=function(){return this.getUploader()||this._getImplicitUploader()};M.prototype._getImplicitUploader=function(){if(!this._oUploader){this._oUploader=new m({httpRequestMethod:this.getHttpRequestMethod()});this._oUploader.setUploadUrl(this.getUploadUrl());this.registerUploaderEvents(this._oUploader);this.addDependent(this._oUploader)}return this._oUploader};M.prototype._setIllustratedMessage=function(){if(!this._illustratedMessage){this._illustratedMessage=new h({illustrationType:this.getNoDataIllustrationType(),illustrationSize:g.Spot,title:this.getNoDataText()?this.getNoDataText():this._oRb.getText("UPLOADSET_WITH_TABLE_NO_DATA_TEXT"),description:this.getNoDataDescription()?this.getNoDataDescription():this._oRb.getText("UPLOADSET_WITH_TABLE_NO_DATA_DESCRIPTION")})}this.setAggregation("_noColumnsMessage",this._illustratedMessage);this.setAggregation("noData",this._illustratedMessage)};M.prototype._setDragDropConfig=function(){var e=new f({sourceAggregation:"items",targetAggregation:"items",dragStart:[this._onDragStartItem,this],drop:[this._onDropItem,this]});var t=new _({dropEffect:"Move",dropPosition:"OnOrBetween",dragEnter:[this._onDragEnterFile,this],drop:[this._onDropFile,this]});this.addDragDropConfig(e);this.addDragDropConfig(t)};M.prototype._onDragStartItem=function(e){this.fireItemDragStart(e)};M.prototype._onDropItem=function(e){this.fireItemDrop(e)};M.prototype._onDragEnterFile=function(e){var t=e.getParameter("dragSession");var i=t.getDragControl();if(i){e.preventDefault()}};M.prototype._onDropFile=function(e){e.preventDefault();if(!this.getUploadEnabled()){p.error("Upload is not enabled, to continue uploading with drag and drop of files enable property 'UploadEnabled' ");return}let t=e.getParameter("browserEvent").dataTransfer.items;t=Array.from(t);t=t.filter(function(e){return e.webkitGetAsEntry()?true:false});const i=t.map(function(e){const t=e.webkitGetAsEntry();return{entryType:t&&t.isFile?"File":"Directory"}});if(t&&t.length>1&&!this.getMultiple()&&!this.getDirectory()){const e=this._oRb.getText("UPLOADSET_WITH_TABLE_MULTIPLE_RESTRICTED");p.warning("Multiple files upload is retsricted for this multiple property set");I.error(e);return}else if(t&&t.length>1&&this.getMultiple()&&!o("File",i)){const e=this._oRb.getText("UPLOADSET_WITH_TABLE_DIRECTORY_RESTRICTED");p.warning("Multiple files upload is retsricted, drag & drop only files");I.error(e);return}if(t&&t.length&&!this.getDirectory()&&o("Directory",i)){const e=this._oRb.getText("UPLOADSET_WITH_TABLE_DIRECTORY_RESTRICTED");p.warning("Directory of files upload is retsricted for this directory property set");I.error(e);return}else if(t&&t.length&&this.getDirectory()&&!o("Directory",i)){const e=this._oRb.getText("UPLOADSET_WITH_TABLE_DROP_DIRECTORY_ALLOWED");p.warning("Directory of files upload is retsricted, drag & drop only directories here.");I.error(e);return}if(t&&t.length){this._getFilesFromDataTransferItems(t).then(e=>{if(e&&e.length){this._processSelectedFileObjects(e)}})}function o(e,t){return t.every(function(t){return t.entryType===e})}};M.prototype._getFilesFromDataTransferItems=function(e){const t=[];return new Promise((o,a)=>{const l=[];for(let t=0;t<e.length;t++){l.push(i(e[t]?.webkitGetAsEntry()))}Promise.all(l).then(e=>{o(t)},e=>{a(e)})});function i(e){return new Promise((o,a)=>{if(e.isFile){e.file(e=>{t.push(e);o(e)},e=>{a(e)})}else if(e.isDirectory){const t=e.createReader();t.readEntries(function(e){const t=[];for(let o=0;o<e.length;o++){t.push(i(e[o]))}o(Promise.all(t))})}})}};M.prototype._openFilePreview=function(e){if(!this.getPreviewDialog()){const e=new T;this.setPreviewDialog(e)}this._filePreviewDialogControl=S.byId(this.getPreviewDialog());if(this._filePreviewDialogControl){this._filePreviewDialogControl._previewItem=e;this._filePreviewDialogControl._items=this.getItems();this._filePreviewDialogControl._open()}};M.prototype._getFileRenameDialog=function(e){const t=s._splitFileName(e.getFileName());let i=this.getMaxFileNameLength();const o=t.extension?t.extension.length+1:0;i=i?i:0;let a=i-o;a=a<0?0:a;const l=new D({type:d.InputType.Text,value:t.name,width:"90%",maxLength:a,liveChange:[this._handleItemNameValidation,this]});l.addStyleClass("sapUiTinyMarginTop");l.addStyleClass("sapUiSmallMarginBegin");const r=new E({text:this._oRb.getText("UPLOADSET_WITH_TABLE_DOCUMENT_RENAME_INPUT_LABEL"),labelFor:l.getId()});r.addStyleClass("sapUiSmallMarginTop");r.addStyleClass("sapUiSmallMarginBegin");r.addStyleClass("sapUiSmallMarginEnd");var n=new U({title:this._oRb.getText("UPLOADSET_WITH_TABLE_DOCUMENT_RENAME_DIALOG_TEXT"),contentWidth:"22.5rem",contentHeight:"12rem",content:[r,l],beginButton:new F({type:d.ButtonType.Emphasized,text:this._oRb.getText("UPLOADSET_WITH_TABLE_DOCUMENT_RENAME_APPLY_BUTTON_TEXT"),press:this._handleItemRenameConfirmation.bind(this),enabled:l.getValueState()!=="Error"}),endButton:new F({text:this._oRb.getText("UPLOADSET_WITH_TABLE_CANCELBUTTON_TEXT"),press:this._handleItemRenameCancel.bind(this)}),customData:{key:"item",value:e},afterClose:function(){n.destroy()}});return n};M.prototype._handleItemRenameCancel=function(e){const t=e.getSource().getParent();const i=t.getContent()[1];const o=t&&t.data?t.data().item:null;const a=s._splitFileName(o.getFileName());if(o&&i&&a.name!==i.getValue()){I.warning(this._oRb.getText("UPLOADSET_WITH_TABLE_DOCUMENT_RENAME_DISCARD_POPUP_CHANGES_TEXT"),{actions:[this._oRb.getText("UPLOADSET_WITH_TABLE_DOCUMENT_RENAME_SAVE_BUTTON_TEXT"),this._oRb.getText("UPLOADSET_WITH_TABLE_DOCUMENT_RENAME_DISCARD_CHANGES_BUTTON_TEXT")],emphasizedAction:this._oRb.getText("UPLOADSET_WITH_TABLE_DOCUMENT_RENAME_SAVE_BUTTON_TEXT"),onClose:e=>{if(e!==this._oRb.getText("UPLOADSET_WITH_TABLE_DOCUMENT_RENAME_SAVE_BUTTON_TEXT")){t.close()}else{var i=t.getBeginButton();var o=new b("click",i);i.firePress(o)}}})}else{t.close()}};M.prototype._handleItemRenameConfirmation=function(e){const t=e.getSource().getParent();const i=t.getContent()[1];if(i&&i.getValueState()==="Error"){i.focus(i);i.setShowValueStateMessage(true);return}const o=t&&t.data?t.data().item:null;const a=s._splitFileName(o.getFileName());if(o&&a.name!==i.getValue()){if(a&&a.extension){o.setFileName(i.getValue()+"."+a.extension)}else{o.setFileName(i.getValue())}t.close();this.fireItemRenamed({item:o})}else{t.close()}};M.prototype._handleItemNameValidation=function(e){const t=e.getSource();let i=t.getValue();i=i.trim();if(i===""){t.setProperty("valueState","Error",true);t.setValueStateText(this._oRb.getText("UPLOADSET_WITH_TABLE_DOCUMENT_RENAME_EMPTY_NAME_VALIDATION_ERROR_MESSAGE"));t.setShowValueStateMessage(true);return}const o=new RegExp(/[@#$]/);if(o.test(i)){t.setShowValueStateMessage(true);t.setProperty("valueState","Error",true);t.setValueStateText(this._oRb.getText("UPLOADSET_WITH_TABLE_DOCUMENT_RENAME_SPLC_VALIDATION_ERROR_MESSAGE","@#$"))}else{t.setShowValueStateMessage(false);t.setProperty("valueState","None",true)}};return M});
//# sourceMappingURL=UploadSetwithTable.js.map